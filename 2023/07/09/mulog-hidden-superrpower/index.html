<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>µ/log hidden superpower</title>
  <meta name="description" content="Between bits and bytes and all other pieces.<br/>A tech blog about Clojure, Software Architecture, and Distributed Systems">
  <meta name="author" content="Bruno Bonacci">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Bits and pieces">
  <meta name="twitter:description" content="Between bits and bytes and all other pieces.<br/>A tech blog about Clojure, Software Architecture, and Distributed Systems">

  <meta property="og:type" content="article">
  <meta property="og:title" content="Bits and pieces">
  <meta property="og:description" content="Between bits and bytes and all other pieces.<br/>A tech blog about Clojure, Software Architecture, and Distributed Systems">

  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.png" sizes="194x194">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" href="/images/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://blog.brunobonacci.com//2023/07/09/mulog-hidden-superrpower/">
  <link rel="alternate" type="application/rss+xml" title="Bits and pieces" href="/feed.xml">
</head>


  <body>
    <span class="mobile btn-mobile-menu">
  <i class="icon icon-list btn-mobile-menu__icon"></i>
  <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
</span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">
  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">
        <a href="/" title="link to home of Bits and pieces">
          <img src="/images/profile.jpg" class="user-image" alt="My Profile Photo">
          <h1 class="panel-cover__title panel-title">Bits and pieces</h1>
        </a>
        <hr class="panel-cover__divider">
        <p class="panel-cover__description">Between bits and bytes and all other pieces.<br/>A tech blog about Clojure, Software Architecture, and Distributed Systems</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/projects" title="link to Bits and pieces Projects" class="blog-button">Projects</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation cover-navigation--primary">
              <ul class="navigation">
                  <li class="navigation__item"><a href="/#blog" title="link to Bits and pieces blog" class="blog-button">Blog</a></li>
              </ul>
          </nav>

          <!--
          <nav class="cover-navigation cover-navigation--primary">
              <ul class="navigation">
                  <li class="navigation__item"><a href="/tags" title="link to Bits and pieces tags" class="blog-button">Tags</a></li>
              </ul>
          </nav>

          <nav class="cover-navigation cover-navigation--primary">
              <ul class="navigation">
                  <li class="navigation__item"><a href="/categories" title="link to Bits and pieces categories" class="blog-button">Categories</a></li>
              </ul>
          </nav>
          -->

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">

            
              <!-- Twitter -->
              <li class="navigation__item">
                <a href="http://twitter.com/BrunoBonacci" title="@BrunoBonacci on Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>
            

            

            
              <!-- LinkedIn -->
              <li class="navigation__item">
                <a href="https://www.linkedin.com/in/brunobonacci" title="brunobonacci on LinkedIn" target="_blank">
                  <i class="icon icon-social-linkedin"></i>
                  <span class="label">LinkedIn</span>
                </a>
              </li>
            

            
              <!-- GitHub -->
              <li class="navigation__item">
                <a href="https://www.github.com/BrunoBonacci" title="BrunoBonacci on GitHub" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>
            

            

            <!-- RSS -->
            <li class="navigation__item">
              <a href="/feed.xml" title="Subscribe" target="_blank">
                <i class="icon icon-rss"></i>
                <span class="label">RSS</span>
              </a>
            </li>

            </ul>
          </nav>

        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>


    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
  <header class="post-header">
    <div class="post-meta">
      <time datetime="9 Jul 2023" class="post-meta__date date">9 Jul 2023</time> &#8226; <span class="post-meta__tags">on <a href="/tags/#Clojure">Clojure</a> <a href="/tags/#µ/log">µ/log</a> <a href="/tags/#aws">aws</a> <a href="/tags/#logging">logging</a> <a href="/tags/#tracing">tracing</a> <a href="/tags/#monitoring">monitoring</a> <a href="/tags/#observability">observability</a> </span>
    </div>
    <h1 class="post-title">µ/log hidden superpower</h1>
  </header>

  <section class="post">
    <blockquote>
  <p>TL;DR:
How we used <em>μ/log</em> to automatically generate
AWS policy for Terraform.</p>

</blockquote>

<p><em>Originally posted at: https://redefine.io/blog/mulog-hidden-superpower/</em></p>

<h3 id="intro">Intro</h3>

<p>Since I developed <a href="https://github.com/BrunoBonacci/mulog"><strong><em>μ/log</em></strong></a> back in 2019, I
have consistently used it in every project I have worked on. My colleagues have
also embraced the idea and adopted it. We have integrated <strong><em>μ/log</em></strong> into every
microservice, lambda function, data-processing job, and larger service we have
developed. We publish the metrics to various systems such as
<a href="https://www.elastic.co/enterprise-search">Elasticsearch</a>, <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html">AWS CloudWatch
Logs/Insights</a>,
and <a href="https://www.jaegertracing.io/">Jaeger Tracing</a> for later analysis.</p>

<p><strong><em>μ/log</em></strong> is a data logging system that goes beyond traditional log systems like
<a href="https://logging.apache.org/log4j/">log4j</a>, <a href="https://logback.qos.ch/">logback</a>,
and <a href="https://docs.oracle.com/en/java/javase/11/core/java-logging-overview.html">Java Logging</a>.
While those systems are designed to log simple sentences like <code class="highlighter-rouge">INFO: Server
started"</code>, <code class="highlighter-rouge">"INFO: Order received"</code> or <code class="highlighter-rouge">"ERROR: Payment failed"</code>, <strong><em>μ/log</em></strong> is designed
to capture data with a rich context. It provides detailed information such as
which server started, on which machine, and which version; which order was
received from which client, and if the payment failed, the reason, amount, and
associated order. It even tracks the processing time for each operation and more.</p>

<p>While traditional loggers like log4j primarily target human consumers, <strong><em>μ/log</em></strong>
events are designed to be consumed by machines. In modern systems composed of
hundreds or thousands of microservices, it is impossible for humans to make
sense of the huge amount of text-based messages alone.
Software is necessary to sift through hundreds of millions or billions of events to
find the desired information.</p>

<p>The surprising outcome of our use of <strong><em>μ/log</em></strong> was that, for the first time in my
over 30 years of experience of developing and running systems, non-technical
individuals within our project were able to identify issues in test and
production systems without requiring developer intervention. This realization
highlighted the effectiveness of our observability approach.</p>

<p>From time to time, I come across new and amazing ways to utilize <strong><em>μ/log</em></strong>. Today, I
want to share another use-case made possible by <strong><em>μ/log</em></strong>’s data capture
capabilities.</p>

<p>Most of our work at <a href="https://redefine.io/">Redefine</a> is based on AWS cloud. We
firmly believe in adhering to cloud best practices such as the <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege">Principle of least Privilege</a>
for our services. Consequently, we strive to avoid using
wildcards in our IAM Policies. While it is not difficult to manually craft a
policy for a tiny AWS Lambda or a small microservice that uses 2-3 services, it
becomes a non-trivial task when deploying larger microservices with numerous
components.</p>

<p>This post illustrates how we leveraged <strong><em>μ/log</em></strong> to automatically generate AWS
policy documents for our services.</p>

<h3 id="μlog-instrumentation"><strong><em>μ/log</em></strong> Instrumentation</h3>

<p>At <a href="https://redefine.io/">Redefine</a>, I have instrumented our core AWS library
with <strong><em>μ/log</em></strong> to track various metrics for our AWS requests. Our core AWS library
wraps the excellent <a href="https://github.com/cognitect-labs/aws-api">Cognitect’s aws-api</a> and incorporates internal
features and patterns used throughout our platform and services.</p>

<p>The general usage is similar to the Cognitect’s aws-api library:</p>

<p><img src="/images/aws-mulog/general-use.png" alt="General use" /></p>

<p>Our internal <code class="highlighter-rouge">invoke</code> function looks like this:</p>

<p><img src="/images/aws-mulog/aws-invoke.png" alt="AWS invoke function" /></p>

<p>Which produces the following event:</p>

<p><img src="/images/aws-mulog/sample-event.png" alt="AWS request sample event" /></p>

<ul>
  <li>Line 1: Indicates that this is an <code class="highlighter-rouge">:aws/request</code> event.</li>
  <li>Line 2: Provides the timestamp when the request was initiated.</li>
  <li>Line 5: Indicates the duration of the request in nanoseconds.</li>
  <li>Line 7: Specifies whether the request was successful or if it failed. In case of an error, additional details are available in <code class="highlighter-rouge">:exception</code>.</li>
  <li>Line 8: Specifies the AWS service that was used.</li>
  <li>Line 9: Identifies the operation that was performed.</li>
  <li>Lines 10-11: Provide the details of the actual request made, including the AWS resource used.</li>
</ul>

<p>It is remarkable how much information can be obtained from a single <strong><em>μ/log</em></strong>
instrumentation. With this setup, we gain a wealth of information for each
request performed on every service.</p>

<p>While our actual implementation is more involved, as it allows tracing
activation at the service/operation/request level and collects additional
parameters, the overall idea remains the same.</p>

<h3 id="extracting-the-aws-information">Extracting the AWS Information</h3>

<p>To generate a policy for one of our services, we simply run our battery of
automated tests and instruct <strong><em>μ/log</em></strong> to write all the events to a file.</p>

<p>We start <strong><em>μ/log</em></strong>’s publisher and configure it to write the events to a file on our disk:</p>

<p><img src="/images/aws-mulog/mulog-config.png" alt="***μ/log*** configuration" /></p>

<p>The next step is to run the tests for the service from which we want to extract
the policy. The tests can be executed against
<a href="https://localstack.cloud/">LocalStack</a> or an AWS test account; it doesn’t
matter. Once the test execution is complete, we have all the data required to
automatically generate our policy.</p>

<h3 id="extracting-the-operations">Extracting the Operations</h3>

<p>The first step is to parse the <a href="https://github.com/edn-format/edn">EDN</a> file and
load the events:</p>

<p><img src="/images/aws-mulog/parse-events.png" alt="Parsing events" /></p>

<p>The expression <code class="highlighter-rouge">(where :mulog/event-name :is? :aws/request)</code> returns a predicate
function that evaluates to true if the event is a <code class="highlighter-rouge">:aws/request</code>. I developed a
small library called <a href="https://github.com/BrunoBonacci/where">where</a> to make
predicate functions easier to be read and understood by humans.</p>

<p>When we execute <code class="highlighter-rouge">parse-file</code>, we obtain the events as Clojure maps:</p>

<p><img src="/images/aws-mulog/reload-events.png" alt="Parsed events" /></p>

<p>To generate an AWS Policy, we need to extract the following fields:</p>
<ul>
  <li>The AWS service used, indicated by the <code class="highlighter-rouge">:api</code> key in our event.</li>
  <li>The operation performed, indicated by the <code class="highlighter-rouge">:operation</code> key.</li>
  <li>Finally, we need to determine the targeted resource.</li>
</ul>

<p>While the first two steps are straightforward, determining the resource requires a little more thought. The location of the resource in use differs for each operation type.</p>

<p>For each event, we generate the following result:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="no">:api</span><span class="w"> </span><span class="no">:s3,</span><span class="w"> </span><span class="no">:action</span><span class="w"> </span><span class="no">:GetObject</span><span class="w"> </span><span class="no">:resource</span><span class="w"> </span><span class="s">"redefine-test"</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>So we encode such information in a nested map and extract the opertaions:</p>

<p><img src="/images/aws-mulog/extract-operations.png" alt="Extract operations" /></p>

<p>Some operations, like DynamoDB’s <code class="highlighter-rouge">TransactWriteItems</code>, bundle multiple other
operations that need to be included individually in the policy. Other
operations, such as DynamoDB’s <code class="highlighter-rouge">BatchGetItem</code>, can target multiple
resources. Thus, in the resource map, instead of providing a keyword to extract
the resource, we can provide a Clojure function to extract the required actions.</p>

<p>In just a few lines of code, we obtain the list of operations performed by our
microservice along with the resource information:</p>

<p><img src="/images/aws-mulog/operations.png" alt="operations" /></p>

<p>Pretty cool 😎!</p>

<p>AWS policies require the resource to be expressed in ARN formatwhile in most
requests, the resource is specified by a simple name. Therefore, we need to
expand short names to AWS ARNs:</p>

<p><img src="/images/aws-mulog/resource-arn.png" alt="resource ARN" /></p>

<p>Now we have the full resource name in ARN format:</p>

<p><img src="/images/aws-mulog/full-operations.png" alt="full operations" /></p>

<p>That’s all we need to generate a policy.</p>

<h3 id="generating-the-policy">Generating the policy</h3>

<p>The final step is to generate a valid Policy document. A policy groups
permissions by resource. We add the following function to our pipeline:</p>

<p><img src="/images/aws-mulog/extract-policy.png" alt="extract policy" /></p>

<p>At <a href="https://redefine.io/">Redefine</a> we use <a href="https://www.terraform.io/">Terraform</a> to manage our infrastructure using
<em>Infrastructure As Code</em> principles.</p>

<p>To produce the Terraform document we need a templating library,
for this project we use <a href="https://github.com/fhd/clostache">clostache</a>
is a very simple library based on <a href="https://mustache.github.io/mustache.5.html">Mustache format</a>.</p>

<p>Here is the template we need:</p>

<p><img src="/images/aws-mulog/template.png" alt="template" /></p>

<p>Now we can render the policy we extracted in our previous steps:</p>

<p><img src="/images/aws-mulog/render-policy.png" alt="render-policy" /></p>

<p>And the final result is a Terraform policy 😎:</p>

<p><img src="/images/aws-mulog/the-policy.png" alt="render-policy" /></p>

<h3 id="conclusion">Conclusion</h3>

<p>The integration of <strong><em>μ/log</em></strong> into our AWS services has proven to be an invaluable
asset. By capturing rich contextual data and generating detailed event logs,
<strong><em>μ/log</em></strong> has empowered both technical and non-technical team members to gain deep
insights into the behavior of our systems. With <strong><em>μ/log</em></strong>, we have achieved a level
of observability that enables quick issue identification and resolution, even
for individuals without deep technical expertise.</p>

<p>Furthermore, we have showcased how <strong><em>μ/log</em></strong> can be utilized to automatically
generate AWS IAM Policies for our services. By leveraging the captured data, we
extract the necessary information about AWS services, operations, and resources,
and transform it into a well-defined policy document. This automation not only
saves us time and effort but also ensures that our policies adhere to the
Principle of Least Privilege, bolstering the security of our infrastructure.</p>

<p>Overall, <strong><em>μ/log</em></strong> has revolutionized the way we approach observability and policy
generation in our AWS environment. Its ability to capture comprehensive data and
facilitate automated processes has significantly improved our efficiency and
reliability. We look forward to continuing our journey with <strong><em>μ/log</em></strong> and exploring
more innovative ways to leverage its capabilities in our microservices
architecture.</p>

  </section>
  <section id="disqus_thread"></section><!-- /#disqus_thread -->
</article>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'bitsandpieces2'; // required: replace example with your forum shortname
        var disqus_config = function () {
          this.page.url = 'https://blog.brunobonacci.com/2023/07/09/mulog-hidden-superrpower/';
          this.page.identifier = '/2023/07/09/mulog-hidden-superrpower';
          this.page.title = 'µ/log hidden superpower';
        };
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



      </div>

      <footer class="footer">
  <span class="footer__copyright">&copy; 2013-2023 Bruno Bonacci. All rights reserved.</span>
</footer>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-51571233-1', 'auto');
  ga('send', 'pageview');
</script>


    </div>
  </body>
</html>
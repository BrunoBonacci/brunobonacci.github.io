<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Cascalog by examples (part 1)</title>
  <meta name="description" content="Between bits and bytes and all other pieces.<br/>A tech blog about Clojure, Software Architecture, and Distributed Systems">
  <meta name="author" content="Bruno Bonacci">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Bits and pieces">
  <meta name="twitter:description" content="Between bits and bytes and all other pieces.<br/>A tech blog about Clojure, Software Architecture, and Distributed Systems">

  <meta property="og:type" content="article">
  <meta property="og:title" content="Bits and pieces">
  <meta property="og:description" content="Between bits and bytes and all other pieces.<br/>A tech blog about Clojure, Software Architecture, and Distributed Systems">

  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.png" sizes="194x194">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" href="/images/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://blog.brunobonacci.com//2014/06/01/cascalog-by-examples-part1/">
  <link rel="alternate" type="application/rss+xml" title="Bits and pieces" href="/feed.xml">
</head>


  <body>
    <span class="mobile btn-mobile-menu">
  <i class="icon icon-list btn-mobile-menu__icon"></i>
  <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
</span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">
  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">
        <a href="/" title="link to home of Bits and pieces">
          <img src="/images/profile.jpg" class="user-image" alt="My Profile Photo">
          <h1 class="panel-cover__title panel-title">Bits and pieces</h1>
        </a>
        <hr class="panel-cover__divider">
        <p class="panel-cover__description">Between bits and bytes and all other pieces.<br/>A tech blog about Clojure, Software Architecture, and Distributed Systems</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/projects" title="link to Bits and pieces Projects" class="blog-button">Projects</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation cover-navigation--primary">
              <ul class="navigation">
                  <li class="navigation__item"><a href="/#blog" title="link to Bits and pieces blog" class="blog-button">Blog</a></li>
              </ul>
          </nav>

          <!--
          <nav class="cover-navigation cover-navigation--primary">
              <ul class="navigation">
                  <li class="navigation__item"><a href="/tags" title="link to Bits and pieces tags" class="blog-button">Tags</a></li>
              </ul>
          </nav>

          <nav class="cover-navigation cover-navigation--primary">
              <ul class="navigation">
                  <li class="navigation__item"><a href="/categories" title="link to Bits and pieces categories" class="blog-button">Categories</a></li>
              </ul>
          </nav>
          -->

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">

            
              <!-- Twitter -->
              <li class="navigation__item">
                <a href="http://twitter.com/BrunoBonacci" title="@BrunoBonacci on Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>
            

            

            
              <!-- LinkedIn -->
              <li class="navigation__item">
                <a href="https://www.linkedin.com/in/brunobonacci" title="brunobonacci on LinkedIn" target="_blank">
                  <i class="icon icon-social-linkedin"></i>
                  <span class="label">LinkedIn</span>
                </a>
              </li>
            

            
              <!-- GitHub -->
              <li class="navigation__item">
                <a href="https://www.github.com/BrunoBonacci" title="BrunoBonacci on GitHub" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>
            

            

            <!-- RSS -->
            <li class="navigation__item">
              <a href="/feed.xml" title="Subscribe" target="_blank">
                <i class="icon icon-rss"></i>
                <span class="label">RSS</span>
              </a>
            </li>

            </ul>
          </nav>

        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>


    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
  <header class="post-header">
    <div class="post-meta">
      <time datetime="1 Jun 2014" class="post-meta__date date">1 Jun 2014</time> &#8226; <span class="post-meta__tags">on <a href="/tags/#Cascalog">Cascalog</a> <a href="/tags/#Clojure">Clojure</a> <a href="/tags/#BigData">BigData</a> <a href="/tags/#Pig">Pig</a> <a href="/tags/#Hive">Hive</a> <a href="/tags/#Hadoop">Hadoop</a> </span>
    </div>
    <h1 class="post-title">Cascalog by examples (part 1)</h1>
  </header>

  <section class="post">
    <p>In the past 2-3 years I’ve been using a number of different
technologies on top of Hadoop for querying and processing BigData.</p>

<p>All of them have advantages and drawbacks, some are easier to start
with, others looks more familiar. The one I’m personally settled with
is Cascalog.</p>

<p>In this post I will make examples of queries using
<a href="http://pig.apache.org/docs/r0.12.1/">Apache Pig</a> and SQL for
comparison. The examples will start with the most basic query and
step-by-step I will add a new elements to it showing how the SQL
compares to Pig and how both compare to Cascalog.</p>

<h1 id="why-cascalog">Why Cascalog?</h1>
<p>There are two broad categories of work that you
normally do with your data: <strong>querying and transforming</strong>, some tools
are better suited for querying such as SQL some others have features
which allow you to perform custom transformation of your data.</p>

<p>Cascalog, in my opinion, is a superior approach for both for a number
of reasons. Firstly it’s a Clojure DSL. Manipulating data with Clojure
is by far easier than most of general purpose languages (Java, Python,
C, Ruby, etc). I’ll explain my claim in another post, but will suffice
to say that it has hundreds of functions to manipulate data, it’s on
the JVM so you can leverage any existing library and the language it’s
<a href="http://en.wikipedia.org/wiki/Homoiconicity">homoiconic</a> which means
that the source code is made of the same data structures (lists) which
you can use for your data, and you can use the same functions that
manipulate your data to manipulate your source code at compile time.</p>

<p>In languages like Pig and Hive, in order to make complex manipulation
of your data you have to write <em>User Defined Functions
(<strong>UDF</strong>)</em>. UDFs are a great way to extend the basic functionality,
however for Hive and Pig you have to use a different language to write
your UDFs as the basic SQL or Pig Latin languages have only a handful
of functions and they lack of basic control structures. Both they
offer the possibility to write UDFs in a number of different languages
(which is great), however this requires a programming paradigm switch
by the
developer. <a href="http://pig.apache.org/docs/r0.12.1/udf.html">Pig allows to write UDFs</a>
in Java, Jython, JavaScript, Groovy, Ruby and Python, for Hive you
need to write then in Java
<a href="http://snowplowanalytics.com/blog/2013/02/08/writing-hive-udfs-and-serdes/">(good article here)</a>. I
won’t make the example of UDFs in Java as the comparison won’t be
fair, <em>life is too short to write them in Java</em>, but let’s assume that
you want to write a UDF for Pig and you want to use Python. If you go
for the JVM platform version (Jython) you won’t be able to use
existing modules coming from Python ecosystem (unless they are in pure
Python). Same for Ruby and Javascript. If you decide to use Python you
will have the setup burden of installing Python and all the modules
that you intend to use in every Hadoop task node. So, you start with a
language such as Pig Latin or SQL, you have to write, compile and
bundle UDFs in a different language, you are constrained to use only
the plain language without importing modules or face the extra
burden of additional setup and, as if is not enough, you have to
smooth the type difference between the two languages during their
communication back and forth with the UDF. For me that’s enough to say
that we can do better than that. Cascalog is a Clojure DSL, so your
main language is Clojure, your custom functions are Clojure, the data
are represented in Clojure data types, and the runtime is the JVM,
no-switch required, no additional compilation required, no
installation burden, and you can use all available libraries in the
JVM ecosystem.</p>

<p>There are other reasons for which Cascalog is better than Pig, Hive et
al. Just to mention few you have a very easy and high level query
language which is based on logic programming and rule inference, you
can and it is encouraged to write sub-queries and reuse
them. Therefore you can write complex processing by composing simple
sub-queries. Cascalog comes with a framework to test your queries and
jobs while other tools have very little to support testing. If you
have done any non-trivial job with Hadoop you know the pain of running
job over and over and have to fix one error at the time. The
integration of Midje (a Clojure testing tool) with Cascalog enables
you to write completely in-memory tests which will behave like in the
Hadoop cluster. Finally probably one of the most important feature,
you have a REPL (Read, Eval, Print Loop) which enables you to explore
your data in a more interactive way.</p>

<p>Another big reason for using Cascalog is that you can reuse your query
and transformation in both: a batch process or a real-time streaming
solution. In fact Cascalog is just an higher lever abstraction on top
of Cascading. Cascalog allows you to compile your query into a lower
level concrete execution plan, and you could also write a custom
compiler to generate an execution plan for a tool which you want to
use. For example Cascalog query can be compiled to MapReduce jobs, to
SQL or Apache Storm.</p>

<p>In this post I won’t be able to cover all those topics but I will try
to give a good introduction to the basic querying capabilities. I will
try to write a follow up post with more advanced use.</p>

<h1 id="stop-talking-and-let-me-see-some-code">Stop talking and let me see some code…</h1>

<p>To start you will need to install <a href="http://leiningen.org/">Leiningen</a>,
then you can clone the repo which contains the data used for this post
and the query samples.</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>git clone https://github.com/BrunoBonacci/cascalog-examples.git
<span class="nb">cd </span>cascalog-examples
lein repl
nREPL server started on port 53433 on host 127.0.0.1
REPL-y 0.2.1
Clojure 1.5.1
    Docs: <span class="o">(</span>doc <span class="k">function</span>-name-here<span class="o">)</span>
          <span class="o">(</span>find-doc <span class="s2">"part-of-name-here"</span><span class="o">)</span>
  Source: <span class="o">(</span><span class="nb">source </span><span class="k">function</span>-name-here<span class="o">)</span>
 Javadoc: <span class="o">(</span>javadoc java-object-or-class-here<span class="o">)</span>
    Exit: Control+D or <span class="o">(</span><span class="nb">exit</span><span class="o">)</span> or <span class="o">(</span>quit<span class="o">)</span>
 Results: Stored <span class="k">in </span>vars <span class="k">*</span>1, <span class="k">*</span>2, <span class="k">*</span>3, an exception <span class="k">in</span> <span class="k">*</span>e

<span class="nv">user</span><span class="o">=</span>&gt;
</code></pre>
</div>

<p>Once the REPL is started you can run:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">use</span><span class="w"> </span><span class="ss">'cascalog-examples.data</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">use</span><span class="w"> </span><span class="ss">'cascalog.api</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">cascalog.logic.ops</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">c</span><span class="p">])</span><span class="w">
</span></code></pre>
</div>

<p>Which will load the sample dataset and the Cascalog APIs.</p>

<p>This will load two taps (Cascalog data sources) one called <code class="highlighter-rouge">USERS</code> and
the second one called <code class="highlighter-rouge">SCORES</code>. At this point let’s see how the sample
data looks like:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nb">take</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">USERS</span><span class="p">)</span><span class="w">
</span><span class="c1">;=&gt; (["Kiayada Wyatt" "kiayada33" 33 "France" true]
;    ["Dominic Ochoa" "dominic43" 72 "United Kingdom" false]
;    ["Cherokee Hammond" "cherokee10" 22 "Russia" false]
;    ["Gemma Foley" "gemma36" 28 "Italy" true]
;    ["Ginger Garcia" "ginger55" 28 "India" false])
</span><span class="w">
</span><span class="p">(</span><span class="nb">count</span><span class="w"> </span><span class="n">USERS</span><span class="p">)</span><span class="w">
</span><span class="c1">;=&gt; 500
</span></code></pre>
</div>

<p><em><strong>NOTE: this data is randomly generated, including names, ages, scores and countries.</strong></em></p>

<p>The Cascalog data format is based on
<a href="http://cascalog.org/articles/getting_started.html#toc_10">tuples</a>. In
the above example we have the first 5 records which each contains 5
tuples which are: <em>name, user, age, country, active</em> and there are 500
users in total.</p>

<p>The <code class="highlighter-rouge">SCORES</code> dataset looks like this:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nb">take</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">(</span><span class="nf">shuffle</span><span class="w"> </span><span class="n">SCORES</span><span class="p">))</span><span class="w">
</span><span class="c1">;=&gt; (["jorden78" "Tetris" 2875]
;    ["noelle32" "Packman" 9389]
;    ["celeste17" "Arkanoid" 3248]
;    ["nadine28" "Packman" 582]
;    ["austin60" "Street Fighter" 3907])
</span><span class="w">
</span><span class="p">(</span><span class="nb">count</span><span class="w"> </span><span class="n">SCORES</span><span class="p">)</span><span class="w">
</span><span class="c1">;=&gt; 6000
</span></code></pre>
</div>

<p>Now you are good to go.</p>

<p>I will show the same query in SQL then Pig and finally Cascalog.</p>

<hr />

<h2 id="show-all-records">Show all records</h2>
<p>A simple projection of fields and of course
you can change the disposition and
the number of fields in the projection side</p>

<h3 id="sql">SQL</h3>
<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="k">user</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="n">active</span>
  <span class="k">FROM</span> <span class="n">USERS</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="pig">Pig</h3>
<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">users</span> <span class="o">=</span> <span class="no">LOAD</span> <span class="s1">'./data/users.tsv'</span> <span class="no">USING</span> <span class="no">PigStorage</span><span class="p">()</span>
        <span class="no">AS</span> <span class="p">(</span><span class="nb">name</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">user</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">age</span><span class="ss">:int</span><span class="p">,</span>
            <span class="n">country</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">active</span><span class="ss">:boolean</span><span class="p">);</span>
<span class="no">DUMP</span> <span class="n">users</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="cascalog">Cascalog</h3>
<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">?&lt;-</span><span class="w"> </span><span class="p">(</span><span class="nf">stdout</span><span class="p">)</span><span class="w">
     </span><span class="p">[</span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">]</span><span class="w">
     </span><span class="p">(</span><span class="nf">USERS</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">))</span><span class="w">
</span></code></pre>
</div>

<p>Here Cascalog adds an implicit reduce step to remove duplicates.
If we really wish to have the same query as SQL and Pig we should
add <code class="highlighter-rouge">(:distinct false)</code> on our Cascalog query.</p>

<p>In reality the above query is split in to parts:
one is the actual query the second part is the
command to execute it and tell Cascalog where
to put the output.</p>

<ul>
  <li>1) query</li>
</ul>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">&lt;-</span><span class="w"> </span><span class="p">[</span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">USERS</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">))</span><span class="w">
</span></code></pre>
</div>

<ul>
  <li>2) execution</li>
</ul>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">?-</span><span class="w"> </span><span class="p">(</span><span class="nf">output</span><span class="p">)</span><span class="w"> </span><span class="n">query</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<p>for this reason we encapsulate the execution
into a Clojure function <code class="highlighter-rouge">run&lt;-</code>
which we’ll use to run our queries.</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">run&lt;-</span><span class="w"> </span><span class="p">[</span><span class="n">query</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">?-</span><span class="w"> </span><span class="p">(</span><span class="nf">stdout</span><span class="p">)</span><span class="w"> </span><span class="n">query</span><span class="p">))</span><span class="w">
</span></code></pre>
</div>

<p>This is come comparable to the SQL statement</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">run&lt;-</span><span class="w">
 </span><span class="p">(</span><span class="nf">&lt;-</span><span class="w"> </span><span class="p">[</span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">]</span><span class="w">
     </span><span class="p">(</span><span class="nf">USERS</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">)))</span><span class="w">
</span></code></pre>
</div>

<hr />

<h2 id="simple-filter">Simple filter</h2>
<p>In this case we apply a simple filter on a field
we want to see all active users</p>

<h3 id="sql-1">SQL</h3>
<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="k">user</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="n">active</span>
  <span class="k">FROM</span> <span class="n">USERS</span>
 <span class="k">WHERE</span> <span class="n">active</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="pig-1">Pig</h3>
<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">users</span> <span class="o">=</span> <span class="no">LOAD</span> <span class="s1">'./data/users.tsv'</span> <span class="no">USING</span> <span class="no">PigStorage</span><span class="p">()</span>
        <span class="no">AS</span> <span class="p">(</span><span class="nb">name</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">user</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">age</span><span class="ss">:int</span><span class="p">,</span>
            <span class="n">country</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">active</span><span class="ss">:boolean</span><span class="p">);</span>
<span class="n">out</span> <span class="o">=</span> <span class="no">FILTER</span> <span class="n">users</span> <span class="no">BY</span> <span class="n">active</span> <span class="o">==</span> <span class="kp">true</span><span class="p">;</span>
<span class="no">DUMP</span> <span class="n">out</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="cascalog-1">Cascalog</h3>
<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">run&lt;-</span><span class="w">
 </span><span class="p">(</span><span class="nf">&lt;-</span><span class="w">  </span><span class="p">[</span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">]</span><span class="w">
      </span><span class="p">(</span><span class="nf">USERS</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">?active</span><span class="w"> </span><span class="n">true</span><span class="p">)))</span><span class="w">
</span></code></pre>
</div>

<hr />

<h2 id="additional-filters">Additional filters</h2>
<p>Now we can see how easy is to add multiple filters</p>

<h3 id="sql-2">SQL</h3>
<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="k">user</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="n">active</span>
  <span class="k">FROM</span> <span class="n">USERS</span>
 <span class="k">WHERE</span> <span class="n">active</span> <span class="o">=</span> <span class="k">true</span>
   <span class="k">AND</span> <span class="n">country</span> <span class="o">=</span> <span class="nv">"India"</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="pig-2">Pig</h3>
<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">users</span> <span class="o">=</span> <span class="no">LOAD</span> <span class="s1">'./data/users.tsv'</span> <span class="no">USING</span> <span class="no">PigStorage</span><span class="p">()</span>
        <span class="no">AS</span> <span class="p">(</span><span class="nb">name</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">user</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">age</span><span class="ss">:int</span><span class="p">,</span>
            <span class="n">country</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">active</span><span class="ss">:boolean</span><span class="p">);</span>
<span class="n">out</span> <span class="o">=</span> <span class="no">FILTER</span> <span class="n">users</span> <span class="no">BY</span> <span class="n">active</span> <span class="o">==</span> <span class="kp">true</span> <span class="no">AND</span> <span class="n">country</span> <span class="o">==</span> <span class="s1">'India'</span><span class="p">;</span>
<span class="no">DUMP</span> <span class="n">out</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="cascalog-2">Cascalog</h3>
<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">run&lt;-</span><span class="w">
 </span><span class="p">(</span><span class="nf">&lt;-</span><span class="w">
  </span><span class="p">[</span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">USERS</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">?active</span><span class="w"> </span><span class="n">true</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="s">"India"</span><span class="p">)))</span><span class="w">
</span></code></pre>
</div>

<hr />

<h2 id="or-condition">OR condition</h2>

<p>Expressing OR conditions is a bit more
complicated. In Clojure #’or is a macro
not a function, so is not composable as function,
and need to be wrapped.</p>

<h3 id="sql-3">SQL</h3>
<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="k">user</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="n">active</span>
  <span class="k">FROM</span> <span class="n">USERS</span>
 <span class="k">WHERE</span> <span class="n">active</span> <span class="o">=</span> <span class="k">true</span>
    <span class="k">OR</span> <span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="pig-3">Pig</h3>
<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">users</span> <span class="o">=</span> <span class="no">LOAD</span> <span class="s1">'./data/users.tsv'</span> <span class="no">USING</span> <span class="no">PigStorage</span><span class="p">()</span>
        <span class="no">AS</span> <span class="p">(</span><span class="nb">name</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">user</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">age</span><span class="ss">:int</span><span class="p">,</span>
            <span class="n">country</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">active</span><span class="ss">:boolean</span><span class="p">);</span>
<span class="n">out</span> <span class="o">=</span> <span class="no">FILTER</span> <span class="n">users</span> <span class="no">BY</span> <span class="n">active</span> <span class="o">==</span> <span class="kp">true</span> <span class="no">OR</span> <span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">70</span><span class="p">;</span>
<span class="no">DUMP</span> <span class="n">out</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="cascalog-3">Cascalog</h3>
<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">deffilterfn</span><span class="w"> </span><span class="n">active-or-senior</span><span class="w"> </span><span class="p">[</span><span class="n">active</span><span class="w"> </span><span class="n">age</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="n">active</span><span class="w">
      </span><span class="p">(</span><span class="nb">&gt;=</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="mi">70</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nf">run&lt;-</span><span class="w">
 </span><span class="p">(</span><span class="nf">&lt;-</span><span class="w">
  </span><span class="p">[</span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">USERS</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">active-or-senior</span><span class="w"> </span><span class="no">:&lt;</span><span class="w"> </span><span class="n">?active</span><span class="w"> </span><span class="n">?age</span><span class="p">)))</span><span class="w">
</span></code></pre>
</div>

<hr />

<h2 id="simple-transformation">Simple transformation</h2>

<p>The optional <code class="highlighter-rouge">:&lt;</code> keyword denotes
input fields to the function
the output can be then placed into field
with <code class="highlighter-rouge">:&gt;</code> for example if we want to perform a simple
transformation on a field, such as making
the username uppercase we can run</p>

<h3 id="sql-4">SQL</h3>
<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="k">UPPER</span><span class="p">(</span><span class="k">user</span><span class="p">),</span> <span class="n">age</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="n">active</span>
  <span class="k">FROM</span> <span class="n">USERS</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="pig-4">Pig</h3>
<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">users</span> <span class="o">=</span> <span class="no">LOAD</span> <span class="s1">'./data/users.tsv'</span> <span class="no">USING</span> <span class="no">PigStorage</span><span class="p">()</span>
        <span class="no">AS</span> <span class="p">(</span><span class="nb">name</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">user</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">age</span><span class="ss">:int</span><span class="p">,</span>
            <span class="n">country</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">active</span><span class="ss">:boolean</span><span class="p">);</span>
<span class="n">out</span> <span class="o">=</span> <span class="no">FOREACH</span> <span class="n">users</span> <span class="no">GENERATE</span> <span class="nb">name</span><span class="p">,</span> <span class="no">UPPER</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="n">age</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="n">active</span><span class="p">;</span>
<span class="no">DUMP</span> <span class="n">out</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="cascalog-4">Cascalog</h3>
<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">run&lt;-</span><span class="w">
 </span><span class="p">(</span><span class="nf">&lt;-</span><span class="w">
  </span><span class="p">[</span><span class="n">?name</span><span class="w"> </span><span class="n">?user2</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">USERS</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">clojure.string/upper-case</span><span class="w"> </span><span class="no">:&lt;</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="no">:&gt;</span><span class="w"> </span><span class="n">?user2</span><span class="p">)))</span><span class="w">
</span></code></pre>
</div>

<p>of course you can map over any custom clojure function,
but in this case you will have to use one of the special def
like <code class="highlighter-rouge">defmapfn</code>. The def* macros from Cascalog they add a bit
of info into the the var so that cascalog will know how
to distribute your custom function in the jar for hadoop</p>

<h3 id="cascalog-5">Cascalog</h3>
<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">defmapfn</span><span class="w"> </span><span class="n">my-upper</span><span class="w"> </span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">clojure.string/upper-case</span><span class="w"> </span><span class="n">s</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">run&lt;-</span><span class="w">
 </span><span class="p">(</span><span class="nf">&lt;-</span><span class="w">
  </span><span class="p">[</span><span class="n">?name</span><span class="w"> </span><span class="n">?user2</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">USERS</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">my-upper</span><span class="w"> </span><span class="no">:&lt;</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="no">:&gt;</span><span class="w"> </span><span class="n">?user2</span><span class="p">)))</span><span class="w">
</span></code></pre>
</div>

<hr />

<h2 id="aggregations">Aggregations</h2>

<p>Some simple aggregations over the entire dataset</p>

<h3 id="sql-5">SQL</h3>
<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">avg</span><span class="p">(</span><span class="n">age</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">USERS</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="pig-5">Pig</h3>
<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">users</span> <span class="o">=</span> <span class="no">LOAD</span> <span class="s1">'./data/users.tsv'</span> <span class="no">USING</span> <span class="no">PigStorage</span><span class="p">()</span>
        <span class="no">AS</span> <span class="p">(</span><span class="nb">name</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">user</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">age</span><span class="ss">:int</span><span class="p">,</span>
            <span class="n">country</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">active</span><span class="ss">:boolean</span><span class="p">);</span>
<span class="n">g</span> <span class="o">=</span> <span class="no">GROUP</span> <span class="n">users</span> <span class="no">ALL</span><span class="p">;</span>
<span class="n">out</span> <span class="o">=</span> <span class="no">FOREACH</span> <span class="n">g</span> <span class="no">GENERATE</span> <span class="no">COUNT</span><span class="p">(</span><span class="n">users</span><span class="p">),</span> <span class="no">AVG</span><span class="p">(</span><span class="n">users</span><span class="p">.</span><span class="nf">age</span><span class="p">);</span>
<span class="no">DUMP</span> <span class="n">out</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="cascalog-6">Cascalog</h3>
<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">run&lt;-</span><span class="w">
 </span><span class="p">(</span><span class="nf">&lt;-</span><span class="w">  </span><span class="p">[</span><span class="n">?count</span><span class="w"> </span><span class="n">?average</span><span class="p">]</span><span class="w">
      </span><span class="p">(</span><span class="nf">USERS</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nf">c/count</span><span class="w"> </span><span class="no">:&gt;</span><span class="w"> </span><span class="n">?count</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nf">c/avg</span><span class="w"> </span><span class="no">:&lt;</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="no">:&gt;</span><span class="w"> </span><span class="n">?average</span><span class="p">)))</span><span class="w">
</span></code></pre>
</div>

<hr />

<h2 id="group-aggregations">Group aggregations</h2>

<p>Now aggregation over a group</p>

<h3 id="sql-6">SQL</h3>
<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">avg</span><span class="p">(</span><span class="n">age</span><span class="p">),</span> <span class="n">country</span>
  <span class="k">FROM</span> <span class="n">USERS</span>
 <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">country</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="pig-6">Pig</h3>
<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">users</span> <span class="o">=</span> <span class="no">LOAD</span> <span class="s1">'./data/users.tsv'</span> <span class="no">USING</span> <span class="no">PigStorage</span><span class="p">()</span>
        <span class="no">AS</span> <span class="p">(</span><span class="nb">name</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">user</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">age</span><span class="ss">:int</span><span class="p">,</span>
            <span class="n">country</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">active</span><span class="ss">:boolean</span><span class="p">);</span>
<span class="n">g</span> <span class="o">=</span> <span class="no">GROUP</span> <span class="n">users</span> <span class="no">BY</span> <span class="n">country</span><span class="p">;</span>
<span class="n">out</span> <span class="o">=</span> <span class="no">FOREACH</span> <span class="n">g</span> <span class="no">GENERATE</span> <span class="no">COUNT</span><span class="p">(</span><span class="n">users</span><span class="p">),</span> <span class="no">AVG</span><span class="p">(</span><span class="n">users</span><span class="p">.</span><span class="nf">age</span><span class="p">),</span> <span class="n">group</span><span class="p">;</span>
<span class="no">DUMP</span> <span class="n">out</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="cascalog-7">Cascalog</h3>
<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">run&lt;-</span><span class="w">
 </span><span class="p">(</span><span class="nf">&lt;-</span><span class="w">  </span><span class="p">[</span><span class="n">?count</span><span class="w"> </span><span class="n">?average</span><span class="w"> </span><span class="n">?country</span><span class="p">]</span><span class="w">
      </span><span class="p">(</span><span class="nf">USERS</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nf">c/count</span><span class="w"> </span><span class="no">:&gt;</span><span class="w"> </span><span class="n">?count</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nf">c/avg</span><span class="w"> </span><span class="no">:&lt;</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="no">:&gt;</span><span class="w"> </span><span class="n">?average</span><span class="p">)))</span><span class="w">
</span></code></pre>
</div>

<p><em>NOTE: this is unintuitive.</em>
In this case we just added a field in the projection
and nothing else and magically the aggregation is now
over a group. Where is the <code class="highlighter-rouge">GROUP BY</code> equivalent clause?</p>

<p>In Cascalog the <code class="highlighter-rouge">GROUP BY</code> is implicit (<a href="http://cascalog.org/articles/getting_started.html#toc_12">as explained here</a>).</p>

<p>Let’s find the number of active users by country</p>

<h3 id="sql-7">SQL</h3>
<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="n">country</span>
  <span class="k">FROM</span> <span class="n">USERS</span>
 <span class="k">WHERE</span> <span class="n">active</span> <span class="o">=</span> <span class="k">true</span>
 <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">country</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="pig-7">Pig</h3>
<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">users</span> <span class="o">=</span> <span class="no">LOAD</span> <span class="s1">'./data/users.tsv'</span> <span class="no">USING</span> <span class="no">PigStorage</span><span class="p">()</span>
        <span class="no">AS</span> <span class="p">(</span><span class="nb">name</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">user</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">age</span><span class="ss">:int</span><span class="p">,</span>
            <span class="n">country</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">active</span><span class="ss">:boolean</span><span class="p">);</span>
<span class="n">a</span> <span class="o">=</span> <span class="no">FILTER</span> <span class="n">users</span> <span class="no">BY</span> <span class="n">active</span> <span class="o">==</span> <span class="kp">true</span><span class="p">;</span>
<span class="n">g</span> <span class="o">=</span> <span class="no">GROUP</span> <span class="n">a</span> <span class="no">BY</span> <span class="n">country</span><span class="p">;</span>
<span class="n">out</span> <span class="o">=</span> <span class="no">FOREACH</span> <span class="n">g</span> <span class="no">GENERATE</span> <span class="no">COUNT</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">group</span><span class="p">;</span>
<span class="no">DUMP</span> <span class="n">out</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="cascalog-8">Cascalog</h3>
<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">run&lt;-</span><span class="w">
 </span><span class="p">(</span><span class="nf">&lt;-</span><span class="w">     </span><span class="p">[</span><span class="n">?count</span><span class="w"> </span><span class="n">?country</span><span class="p">]</span><span class="w">
         </span><span class="p">(</span><span class="nf">USERS</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">)</span><span class="w">
         </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">?active</span><span class="w"> </span><span class="n">true</span><span class="p">)</span><span class="w">
         </span><span class="p">(</span><span class="nf">c/count</span><span class="w"> </span><span class="no">:&gt;</span><span class="w"> </span><span class="n">?count</span><span class="p">)))</span><span class="w">
</span></code></pre>
</div>

<hr />

<h2 id="post-aggregations-filtering-having">Post aggregations filtering (<code class="highlighter-rouge">HAVING</code>)</h2>

<p>If you want to find the number of active users by country
and display only those who have 25 or more active users</p>

<h3 id="sql-8">SQL</h3>
<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="k">count</span><span class="p">,</span> <span class="n">country</span>
  <span class="k">FROM</span> <span class="n">USERS</span>
 <span class="k">WHERE</span> <span class="n">active</span> <span class="o">=</span> <span class="k">true</span>
 <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">country</span>
<span class="k">HAVING</span> <span class="k">count</span> <span class="o">&gt;=</span> <span class="mi">25</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="pig-8">Pig</h3>
<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">users</span> <span class="o">=</span> <span class="no">LOAD</span> <span class="s1">'./data/users.tsv'</span> <span class="no">USING</span> <span class="no">PigStorage</span><span class="p">()</span>
        <span class="no">AS</span> <span class="p">(</span><span class="nb">name</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">user</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">age</span><span class="ss">:int</span><span class="p">,</span>
            <span class="n">country</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">active</span><span class="ss">:boolean</span><span class="p">);</span>
<span class="n">a</span> <span class="o">=</span> <span class="no">FILTER</span> <span class="n">users</span> <span class="no">BY</span> <span class="n">active</span> <span class="o">==</span> <span class="kp">true</span><span class="p">;</span>
<span class="n">g</span> <span class="o">=</span> <span class="no">GROUP</span> <span class="n">a</span> <span class="no">BY</span> <span class="n">country</span><span class="p">;</span>
<span class="n">f</span> <span class="o">=</span> <span class="no">FOREACH</span> <span class="n">g</span> <span class="no">GENERATE</span> <span class="no">COUNT</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="n">as</span> <span class="n">count</span><span class="p">,</span> <span class="n">group</span> <span class="n">as</span> <span class="n">country</span><span class="p">;</span>
<span class="n">out</span> <span class="o">=</span> <span class="no">FILTER</span> <span class="n">f</span> <span class="no">BY</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">25</span><span class="p">;</span>
<span class="no">DUMP</span> <span class="n">out</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="cascalog-9">Cascalog</h3>
<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">run&lt;-</span><span class="w">
 </span><span class="p">(</span><span class="nf">&lt;-</span><span class="w">     </span><span class="p">[</span><span class="n">?count</span><span class="w"> </span><span class="n">?country</span><span class="p">]</span><span class="w">
         </span><span class="p">(</span><span class="nf">USERS</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">)</span><span class="w">
         </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">?active</span><span class="w"> </span><span class="n">true</span><span class="p">)</span><span class="w">
         </span><span class="p">(</span><span class="nf">c/count</span><span class="w"> </span><span class="no">:&gt;</span><span class="w"> </span><span class="n">?count</span><span class="p">)</span><span class="w">
         </span><span class="p">(</span><span class="nb">&gt;=</span><span class="w"> </span><span class="n">?count</span><span class="w"> </span><span class="mi">25</span><span class="p">)))</span><span class="w">
</span></code></pre>
</div>

<hr />

<h2 id="sorting">Sorting</h2>

<p>to sort the result set we can use the :sort predicate</p>

<h3 id="sql-9">SQL</h3>
<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span> <span class="k">user</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="n">active</span>
  <span class="k">FROM</span> <span class="n">USERS</span>
 <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">age</span> <span class="k">DESC</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="pig-9">Pig</h3>
<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">users</span> <span class="o">=</span> <span class="no">LOAD</span> <span class="s1">'./data/users.tsv'</span> <span class="no">USING</span> <span class="no">PigStorage</span><span class="p">()</span>
        <span class="no">AS</span> <span class="p">(</span><span class="nb">name</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">user</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">age</span><span class="ss">:int</span><span class="p">,</span>
            <span class="n">country</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">active</span><span class="ss">:boolean</span><span class="p">);</span>
<span class="n">out</span> <span class="o">=</span> <span class="no">ORDER</span> <span class="n">users</span> <span class="no">BY</span> <span class="n">age</span> <span class="no">DESC</span><span class="p">;</span>
<span class="no">DUMP</span> <span class="n">out</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="cascalog-10">Cascalog</h3>
<p>Global sorting is not very common in big data,
most of the times you will sort by group.
However if you have to sort the entire dataset
you have to write a function which takes
a query and a list of fields to sort by.</p>

<p>In this case Cascalog it makes it more difficult that
any other tool :-(, you have to write a custom function.
Luckily you can write it once and reuse it many times.</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">cascalog.logic.vars</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">v</span><span class="p">])</span><span class="w">
</span><span class="p">(</span><span class="nb">import</span><span class="w"> </span><span class="ss">'cascalog.ops.IdentityBuffer</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">global-sort</span><span class="w"> </span><span class="p">[</span><span class="n">sq</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="n">desc?</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">out-fields</span><span class="w"> </span><span class="p">(</span><span class="nf">get-out-fields</span><span class="w"> </span><span class="n">sq</span><span class="p">)</span><span class="w">
        </span><span class="n">new-out-fields</span><span class="w"> </span><span class="p">(</span><span class="nf">v/gen-nullable-vars</span><span class="w"> </span><span class="p">(</span><span class="nb">count</span><span class="w"> </span><span class="n">out-fields</span><span class="p">))]</span><span class="w">
    </span><span class="p">(</span><span class="nf">&lt;-</span><span class="w"> </span><span class="n">new-out-fields</span><span class="w">
        </span><span class="p">(</span><span class="nf">sq</span><span class="w"> </span><span class="no">:&gt;&gt;</span><span class="w"> </span><span class="n">out-fields</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="no">:sort</span><span class="w"> </span><span class="no">:&lt;&lt;</span><span class="w"> </span><span class="n">fields</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="no">:reverse</span><span class="w"> </span><span class="n">desc?</span><span class="p">)</span><span class="w">
        </span><span class="p">((</span><span class="nf">IdentityBuffer.</span><span class="p">)</span><span class="w"> </span><span class="no">:&lt;&lt;</span><span class="w"> </span><span class="n">out-fields</span><span class="w"> </span><span class="no">:&gt;&gt;</span><span class="w"> </span><span class="n">new-out-fields</span><span class="p">))))</span><span class="w">

</span><span class="p">(</span><span class="nf">run&lt;-</span><span class="w">
 </span><span class="p">(</span><span class="nf">global-sort</span><span class="w">
  </span><span class="p">(</span><span class="nf">&lt;-</span><span class="w"> </span><span class="p">[</span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">]</span><span class="w">
      </span><span class="p">(</span><span class="nf">USERS</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">))</span><span class="w">
  </span><span class="p">[</span><span class="s">"?age"</span><span class="p">]</span><span class="w"> </span><span class="n">true</span><span class="p">))</span><span class="w">
</span></code></pre>
</div>

<hr />

<h2 id="top-n-by-group">Top-N by group</h2>

<p>Here we want to find the two oldest active user per country</p>

<p>To do this in SQL we need to do some serious SQL kung-fu!!
Frankly it’s unreadable, none could easily say what this
SQL query does.</p>

<h3 id="sql-10">SQL</h3>
<div class="language-sql highlighter-rouge"><pre class="highlight"><code>    <span class="k">SELECT</span> <span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="k">user</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">age</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">country</span>
     <span class="k">FROM</span> <span class="n">USERS</span> <span class="k">as</span> <span class="n">u</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">USERS</span> <span class="k">as</span> <span class="n">u2</span>
       <span class="k">ON</span> <span class="n">u</span><span class="p">.</span><span class="n">country</span> <span class="o">=</span> <span class="n">u2</span><span class="p">.</span><span class="n">country</span>
      <span class="k">AND</span> <span class="n">u</span><span class="p">.</span><span class="n">age</span> <span class="o">&lt;=</span> <span class="n">u2</span><span class="p">.</span><span class="n">age</span>
    <span class="k">WHERE</span>  <span class="n">u</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="k">true</span>
      <span class="k">AND</span> <span class="n">u2</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="k">true</span>
 <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">u</span><span class="p">.</span><span class="n">country</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="k">user</span>
   <span class="k">HAVING</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">;</span>
</code></pre>
</div>
<p><strong>NOTE: this O(n^2) very bad!!!</strong></p>

<p>Top-N by group is a rather complicated matter in SQL,
here you can find some alternative approaches
<a href="http://www.xaprb.com/blog/2006/12/07/how-to-select-the-firstleastmax-row-per-group-in-sql/">http://www.xaprb.com/blog/2006/12/07/how-to-select-the-firstleastmax-row-per-group-in-sql/</a></p>

<p>The Pig version is a bit more intuitive:</p>

<h3 id="pig-10">Pig</h3>
<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">users</span> <span class="o">=</span> <span class="no">LOAD</span> <span class="s1">'./data/users.tsv'</span> <span class="no">USING</span> <span class="no">PigStorage</span><span class="p">()</span>
        <span class="no">AS</span> <span class="p">(</span><span class="nb">name</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">user</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">age</span><span class="ss">:int</span><span class="p">,</span>
            <span class="n">country</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">active</span><span class="ss">:boolean</span><span class="p">);</span>
<span class="n">a</span> <span class="o">=</span> <span class="no">FILTER</span> <span class="n">users</span> <span class="no">BY</span> <span class="n">active</span> <span class="o">==</span> <span class="kp">true</span><span class="p">;</span>
<span class="n">g</span> <span class="o">=</span> <span class="no">GROUP</span> <span class="n">a</span> <span class="no">BY</span> <span class="n">country</span><span class="p">;</span>
<span class="n">out</span> <span class="o">=</span> <span class="no">FOREACH</span> <span class="n">g</span> <span class="p">{</span>
   <span class="n">s</span> <span class="o">=</span> <span class="no">ORDER</span> <span class="n">a</span> <span class="n">by</span> <span class="n">age</span> <span class="no">DESC</span><span class="p">;</span>
   <span class="n">l</span> <span class="o">=</span> <span class="no">LIMIT</span> <span class="n">s</span> <span class="mi">2</span><span class="p">;</span>
   <span class="no">GENERATE</span> <span class="no">FLATTEN</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
<span class="p">}</span>
<span class="no">DUMP</span> <span class="n">out</span><span class="p">;</span>
</code></pre>
</div>

<p>However in Cascalog it’s very easy:
you make a projection by country (which creates a group)
and in the group you sort by age, reverse
and take the top 2</p>

<h3 id="cascalog-11">Cascalog</h3>
<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">run&lt;-</span><span class="w">
 </span><span class="p">(</span><span class="nf">&lt;-</span><span class="w">    </span><span class="p">[</span><span class="n">?name1</span><span class="w"> </span><span class="n">?user1</span><span class="w"> </span><span class="n">?age1</span><span class="w"> </span><span class="n">?country</span><span class="p">]</span><span class="w">
        </span><span class="p">(</span><span class="nf">USERS</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">?active</span><span class="w"> </span><span class="n">true</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="no">:sort</span><span class="w"> </span><span class="n">?age</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="no">:reverse</span><span class="w"> </span><span class="n">true</span><span class="p">)</span><span class="w">
        </span><span class="p">((</span><span class="nf">c/limit</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="no">:&gt;</span><span class="w"> </span><span class="n">?name1</span><span class="w"> </span><span class="n">?user1</span><span class="w"> </span><span class="n">?age1</span><span class="p">)))</span><span class="w">
</span></code></pre>
</div>

<hr />

<h2 id="joins">Joins</h2>

<p>If we want to display the real name of each user together
with the game they played and their score we will need to:</p>

<h3 id="sql-11">SQL</h3>
<div class="language-sql highlighter-rouge"><pre class="highlight"><code>    <span class="k">SELECT</span> <span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">game</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">score</span>
     <span class="k">FROM</span> <span class="n">USERS</span> <span class="k">as</span> <span class="n">u</span><span class="p">,</span> <span class="n">SCORES</span> <span class="k">as</span> <span class="n">s</span>
    <span class="k">WHERE</span> <span class="n">u</span><span class="p">.</span><span class="k">user</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="k">user</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="pig-11">Pig</h3>
<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">users</span> <span class="o">=</span> <span class="no">LOAD</span> <span class="s1">'./data/users.tsv'</span> <span class="no">USING</span> <span class="no">PigStorage</span><span class="p">()</span>
        <span class="no">AS</span> <span class="p">(</span><span class="nb">name</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">user</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">age</span><span class="ss">:int</span><span class="p">,</span>
            <span class="n">country</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">active</span><span class="ss">:boolean</span><span class="p">);</span>
<span class="n">scores</span> <span class="o">=</span> <span class="no">LOAD</span> <span class="s1">'./data/scores.tsv'</span> <span class="no">USING</span> <span class="no">PigStorage</span><span class="p">()</span>
        <span class="no">AS</span> <span class="p">(</span><span class="n">user</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">game</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">score</span><span class="ss">:int</span><span class="p">);</span>
<span class="n">j</span> <span class="o">=</span> <span class="no">JOIN</span> <span class="n">users</span> <span class="no">BY</span> <span class="n">user</span><span class="p">,</span> <span class="n">scores</span> <span class="n">by</span> <span class="n">user</span><span class="p">;</span>
<span class="n">out</span> <span class="o">=</span> <span class="no">FOREACH</span> <span class="n">j</span> <span class="no">GENERATE</span> <span class="n">users</span><span class="o">::</span><span class="nb">name</span><span class="p">,</span> <span class="n">scores</span><span class="o">::</span><span class="n">game</span><span class="p">,</span> <span class="n">scores</span><span class="o">::</span><span class="n">score</span><span class="p">;</span>
<span class="no">DUMP</span> <span class="n">out</span><span class="p">;</span>
</code></pre>
</div>

<p>In order to join multiple datasources you need just to add their tap
and by mentioning the same field name on multiple sources
Cascalog will automatically infer the join key.</p>

<h3 id="cascalog-12">Cascalog</h3>
<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">run&lt;-</span><span class="w">
 </span><span class="p">(</span><span class="nf">&lt;-</span><span class="w">    </span><span class="p">[</span><span class="n">?name</span><span class="w"> </span><span class="n">?game</span><span class="w"> </span><span class="n">?score</span><span class="p">]</span><span class="w">
        </span><span class="p">(</span><span class="nf">USERS</span><span class="w">  </span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nf">SCORES</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?game</span><span class="w"> </span><span class="n">?score</span><span class="p">)))</span><span class="w">
</span></code></pre>
</div>

<p>If we want to display all user which are younger than 15
and have more than 6000 points playing Tetris we will need to:</p>

<h3 id="sql-12">SQL</h3>
<div class="language-sql highlighter-rouge"><pre class="highlight"><code>    <span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">score</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">age</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">country</span>
      <span class="k">FROM</span> <span class="n">USERS</span> <span class="n">u</span><span class="p">,</span> <span class="n">SCORES</span> <span class="n">s</span>
     <span class="k">WHERE</span> <span class="n">u</span><span class="p">.</span><span class="k">user</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="k">user</span>
       <span class="k">AND</span> <span class="n">s</span><span class="p">.</span><span class="n">game</span> <span class="o">=</span> <span class="nv">"Tetris"</span>
       <span class="k">AND</span> <span class="n">u</span><span class="p">.</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">15</span>
       <span class="k">AND</span> <span class="n">s</span><span class="p">.</span><span class="n">score</span> <span class="o">&gt;</span> <span class="mi">6000</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="pig-12">Pig</h3>
<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">users</span> <span class="o">=</span> <span class="no">LOAD</span> <span class="s1">'./data/users.tsv'</span> <span class="no">USING</span> <span class="no">PigStorage</span><span class="p">()</span>
        <span class="no">AS</span> <span class="p">(</span><span class="nb">name</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">user</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">age</span><span class="ss">:int</span><span class="p">,</span>
            <span class="n">country</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">active</span><span class="ss">:boolean</span><span class="p">);</span>
<span class="n">scores</span> <span class="o">=</span> <span class="no">LOAD</span> <span class="s1">'./data/scores.tsv'</span> <span class="no">USING</span> <span class="no">PigStorage</span><span class="p">()</span>
        <span class="no">AS</span> <span class="p">(</span><span class="n">user</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">game</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">score</span><span class="ss">:int</span><span class="p">);</span>
<span class="n">fu</span> <span class="o">=</span> <span class="no">FILTER</span> <span class="n">users</span> <span class="no">BY</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span>
<span class="n">fs</span> <span class="o">=</span> <span class="no">FILTER</span> <span class="n">scores</span> <span class="no">BY</span> <span class="n">game</span> <span class="o">==</span> <span class="s1">'Tetris'</span> <span class="no">AND</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">6000</span><span class="p">;</span>
<span class="n">j</span> <span class="o">=</span> <span class="no">JOIN</span> <span class="n">fu</span> <span class="no">BY</span> <span class="n">user</span><span class="p">,</span> <span class="n">fs</span> <span class="n">by</span> <span class="n">user</span><span class="p">;</span>
<span class="n">out</span> <span class="o">=</span> <span class="no">FOREACH</span> <span class="n">j</span> <span class="no">GENERATE</span> <span class="n">fs</span><span class="o">::</span><span class="n">score</span><span class="p">,</span> <span class="n">fu</span><span class="o">::</span><span class="nb">name</span><span class="p">,</span> <span class="n">fu</span><span class="o">::</span><span class="n">age</span><span class="p">,</span> <span class="n">fu</span><span class="o">::</span><span class="n">country</span><span class="p">;</span>
<span class="no">DUMP</span> <span class="n">out</span><span class="p">;</span>
</code></pre>
</div>

<p>In order to join multiple datasources you need just to add their tap
and by mentioning the same field name on multiple sources
Cascalog will automatically infer the join key.</p>

<h3 id="cascalog-13">Cascalog</h3>
<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">run&lt;-</span><span class="w">
 </span><span class="p">(</span><span class="nf">&lt;-</span><span class="w">    </span><span class="p">[</span><span class="n">?score</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="p">]</span><span class="w">
        </span><span class="p">(</span><span class="nf">USERS</span><span class="w">  </span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">?active</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nf">SCORES</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?game</span><span class="w"> </span><span class="n">?score</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">?game</span><span class="w"> </span><span class="s">"Tetris"</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">?score</span><span class="w"> </span><span class="mi">6000</span><span class="p">)))</span><span class="w">
</span></code></pre>
</div>

<p>If we want to find the who scored the highest points
at the Tetris game we will need to:</p>

<h3 id="sql-13">SQL</h3>
<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">score</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">age</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">country</span>
  <span class="k">FROM</span> <span class="n">USERS</span> <span class="n">u</span><span class="p">,</span> <span class="n">SCORES</span> <span class="n">s</span>
 <span class="k">WHERE</span> <span class="n">u</span><span class="p">.</span><span class="k">user</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="k">user</span>
   <span class="k">AND</span> <span class="n">s</span><span class="p">.</span><span class="n">game</span> <span class="o">=</span> <span class="s1">'Tetris'</span>
   <span class="k">AND</span> <span class="n">s</span><span class="p">.</span><span class="n">score</span> <span class="o">=</span> <span class="p">(</span> <span class="k">SELECT</span> <span class="k">max</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">SCORES</span> <span class="k">WHERE</span> <span class="n">game</span> <span class="o">=</span> <span class="s1">'Tetris'</span> <span class="p">);</span>
</code></pre>
</div>

<h3 id="pig-13">Pig</h3>
<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">users</span> <span class="o">=</span> <span class="no">LOAD</span> <span class="s1">'./data/users.tsv'</span> <span class="no">USING</span> <span class="no">PigStorage</span><span class="p">()</span>
        <span class="no">AS</span> <span class="p">(</span><span class="nb">name</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">user</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">age</span><span class="ss">:int</span><span class="p">,</span>
            <span class="n">country</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">active</span><span class="ss">:boolean</span><span class="p">);</span>
<span class="n">scores</span> <span class="o">=</span> <span class="no">LOAD</span> <span class="s1">'./data/scores.tsv'</span> <span class="no">USING</span> <span class="no">PigStorage</span><span class="p">()</span>
        <span class="no">AS</span> <span class="p">(</span><span class="n">user</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">game</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">score</span><span class="ss">:int</span><span class="p">);</span>
<span class="n">fs</span> <span class="o">=</span> <span class="no">FILTER</span> <span class="n">scores</span> <span class="no">BY</span> <span class="n">game</span> <span class="o">==</span> <span class="s1">'Tetris'</span><span class="p">;</span>
<span class="n">gfs</span> <span class="o">=</span> <span class="no">GROUP</span> <span class="n">fs</span> <span class="no">ALL</span><span class="p">;</span>
<span class="n">maxscore</span> <span class="o">=</span> <span class="no">FOREACH</span> <span class="n">gfs</span> <span class="no">GENERATE</span> <span class="no">MAX</span><span class="p">(</span><span class="n">fs</span><span class="p">.</span><span class="nf">score</span><span class="p">);</span>
<span class="n">j</span> <span class="o">=</span> <span class="no">JOIN</span> <span class="n">users</span> <span class="no">BY</span> <span class="n">user</span><span class="p">,</span> <span class="n">fs</span> <span class="n">by</span> <span class="n">user</span><span class="p">;</span>
<span class="n">j2</span> <span class="o">=</span> <span class="no">JOIN</span> <span class="n">j</span> <span class="no">BY</span> <span class="n">score</span><span class="p">,</span> <span class="n">maxscore</span> <span class="no">BY</span> <span class="vg">$0</span><span class="p">;</span>
<span class="n">out</span> <span class="o">=</span> <span class="no">FOREACH</span> <span class="n">j2</span> <span class="no">GENERATE</span> <span class="n">j</span><span class="o">::</span><span class="n">fs</span><span class="o">::</span><span class="n">score</span><span class="p">,</span> <span class="n">j</span><span class="o">::</span><span class="n">users</span><span class="o">::</span><span class="nb">name</span><span class="p">,</span> <span class="n">j</span><span class="o">::</span><span class="n">users</span><span class="o">::</span><span class="n">age</span><span class="p">,</span> <span class="n">j</span><span class="o">::</span><span class="n">users</span><span class="o">::</span><span class="n">country</span><span class="p">;</span>
<span class="no">DUMP</span> <span class="n">out</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="cascalog-14">Cascalog</h3>
<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">max-game-score</span><span class="w"> </span><span class="p">[</span><span class="n">game</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">&lt;-</span><span class="w"> </span><span class="p">[</span><span class="n">?mscore</span><span class="p">]</span><span class="w">
      </span><span class="p">(</span><span class="nf">SCORES</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">?game</span><span class="w"> </span><span class="n">?score</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="n">?game</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nf">c/max</span><span class="w"> </span><span class="n">?score</span><span class="w"> </span><span class="no">:&gt;</span><span class="w"> </span><span class="n">?mscore</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nf">run&lt;-</span><span class="w">
 </span><span class="p">(</span><span class="nf">max-game-score</span><span class="w"> </span><span class="s">"Tetris"</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">run&lt;-</span><span class="w">
 </span><span class="p">(</span><span class="nf">&lt;-</span><span class="w"> </span><span class="p">[</span><span class="n">?score</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="p">]</span><span class="w">
     </span><span class="p">(</span><span class="nf">USERS</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w">
     </span><span class="p">(</span><span class="nf">SCORES</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?game</span><span class="w"> </span><span class="n">?score</span><span class="p">)</span><span class="w">
     </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">?game</span><span class="w"> </span><span class="s">"Tetris"</span><span class="p">)</span><span class="w">
     </span><span class="p">((</span><span class="nf">max-game-score</span><span class="w"> </span><span class="s">"Tetris"</span><span class="p">)</span><span class="w"> </span><span class="n">?score</span><span class="p">)))</span><span class="w">
</span></code></pre>
</div>

<p>As we seen from the previous example is very easy to define sub query and reuse them.
In this example I want to find the top 3 scorer per game.
This type of queries is very common for the analytics folks (top-n by group)</p>

<h3 id="sql-14">SQL</h3>
<div class="language-sql highlighter-rouge"><pre class="highlight"><code>   <span class="k">SELECT</span> <span class="n">s</span><span class="p">.</span><span class="n">game</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">score</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">age</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">country</span>
     <span class="k">FROM</span> <span class="n">SCORES</span> <span class="k">as</span> <span class="n">s</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">SCORES</span> <span class="k">as</span> <span class="n">s2</span>
       <span class="k">ON</span> <span class="n">s</span><span class="p">.</span><span class="n">game</span> <span class="o">=</span> <span class="n">s2</span><span class="p">.</span><span class="n">game</span>
      <span class="k">AND</span> <span class="n">s</span><span class="p">.</span><span class="n">score</span> <span class="o">&lt;=</span> <span class="n">s2</span><span class="p">.</span><span class="n">score</span>
     <span class="k">JOIN</span> <span class="n">USERS</span> <span class="k">as</span> <span class="n">u</span>
       <span class="k">ON</span> <span class="n">s</span><span class="p">.</span><span class="k">user</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="k">user</span>
 <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">s</span><span class="p">.</span><span class="n">game</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="k">user</span>
   <span class="k">HAVING</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">&lt;=</span><span class="mi">3</span><span class="p">;</span>
</code></pre>
</div>
<p><strong>NOTE: this O(n^2) very bad!!!</strong></p>

<h3 id="pig-14">Pig</h3>
<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">users</span> <span class="o">=</span> <span class="no">LOAD</span> <span class="s1">'./data/users.tsv'</span> <span class="no">USING</span> <span class="no">PigStorage</span><span class="p">()</span>
        <span class="no">AS</span> <span class="p">(</span><span class="nb">name</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">user</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">age</span><span class="ss">:int</span><span class="p">,</span>
            <span class="n">country</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">active</span><span class="ss">:boolean</span><span class="p">);</span>
<span class="n">scores</span> <span class="o">=</span> <span class="no">LOAD</span> <span class="s1">'./data/scores.tsv'</span> <span class="no">USING</span> <span class="no">PigStorage</span><span class="p">()</span>
        <span class="no">AS</span> <span class="p">(</span><span class="n">user</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">game</span><span class="ss">:chararray</span><span class="p">,</span> <span class="n">score</span><span class="ss">:int</span><span class="p">);</span>
<span class="n">j</span> <span class="o">=</span> <span class="no">JOIN</span> <span class="n">users</span> <span class="no">BY</span> <span class="n">user</span><span class="p">,</span> <span class="n">scores</span> <span class="n">by</span> <span class="n">user</span><span class="p">;</span>
<span class="n">g</span> <span class="o">=</span> <span class="no">GROUP</span> <span class="n">j</span> <span class="no">BY</span> <span class="n">game</span><span class="p">;</span>
<span class="n">t</span> <span class="o">=</span> <span class="no">FOREACH</span> <span class="n">g</span> <span class="p">{</span>
   <span class="n">s</span> <span class="o">=</span> <span class="no">ORDER</span> <span class="n">j</span> <span class="n">by</span> <span class="n">score</span> <span class="no">DESC</span><span class="p">;</span>
   <span class="n">l</span> <span class="o">=</span> <span class="no">LIMIT</span> <span class="n">s</span> <span class="mi">3</span><span class="p">;</span>
   <span class="no">GENERATE</span> <span class="no">FLATTEN</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">out</span> <span class="o">=</span> <span class="no">FOREACH</span> <span class="n">t</span> <span class="no">GENERATE</span> <span class="n">game</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">country</span><span class="p">;</span>
<span class="no">DUMP</span> <span class="n">out</span><span class="p">;</span>
</code></pre>
</div>

<h3 id="cascalog-15">Cascalog</h3>
<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">run&lt;-</span><span class="w">
 </span><span class="p">(</span><span class="nf">&lt;-</span><span class="w"> </span><span class="p">[</span><span class="n">?game</span><span class="w"> </span><span class="n">?score1</span><span class="w"> </span><span class="n">?name1</span><span class="w"> </span><span class="n">?age1</span><span class="w"> </span><span class="n">?country1</span><span class="p">]</span><span class="w">
     </span><span class="p">(</span><span class="nf">SCORES</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?game</span><span class="w"> </span><span class="n">?score</span><span class="p">)</span><span class="w">
     </span><span class="p">(</span><span class="nf">USERS</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?user</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w">
     </span><span class="p">(</span><span class="no">:sort</span><span class="w"> </span><span class="n">?score</span><span class="p">)</span><span class="w">
     </span><span class="p">(</span><span class="no">:reverse</span><span class="w"> </span><span class="n">true</span><span class="p">)</span><span class="w">
     </span><span class="p">((</span><span class="nf">c/limit</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="no">:&lt;</span><span class="w"> </span><span class="n">?name</span><span class="w"> </span><span class="n">?score</span><span class="w"> </span><span class="n">?age</span><span class="w"> </span><span class="n">?country</span><span class="w"> </span><span class="no">:&gt;</span><span class="w"> </span><span class="n">?name1</span><span class="w"> </span><span class="n">?score1</span><span class="w"> </span><span class="n">?age1</span><span class="w"> </span><span class="n">?country1</span><span class="p">)))</span><span class="w">
</span></code></pre>
</div>

<h2 id="conclusion-has-we-seen-in-the-previous-exmaples-cascalog-is-very">Conclusion Has we seen in the previous exmaples Cascalog is very</h2>
<p>compact and intuitive. Compared to Pig and SQL is slightly more
succint. However in more complex examples is were we can really
appreciate its simplicity. Again, Cascalog has plenty of other
features which I will try to cover in future posts. The best way to
learn it is to try it, and if you find difficulties you can always
post a message to the
<a href="https://groups.google.com/forum/#!forum/cascalog-user">Cascalog user group</a>.</p>

<hr />

<p>For this article I’ve used:</p>

<ul>
  <li>Cascalog 2.1.0 with Clojure 1.5.1</li>
  <li>Apache Pig 0.12.1</li>
  <li>MySql 5.5.37</li>
</ul>

<p>List of updates:</p>

<ul>
  <li>2014/06/06 Fixed mis-labelled code block (thanks Shashy)</li>
</ul>

  </section>
  <section id="disqus_thread"></section><!-- /#disqus_thread -->
</article>

    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'bitsandpieces2'; // required: replace example with your forum shortname
        var disqus_config = function () {
          this.page.url = 'https://blog.brunobonacci.com/2014/06/01/cascalog-by-examples-part1/';
          this.page.identifier = '/2014/06/01/cascalog-by-examples-part1';
          this.page.title = 'Cascalog by examples (part 1)';
        };
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



      </div>

      <footer class="footer">
  <span class="footer__copyright">&copy; 2013-2023 Bruno Bonacci. All rights reserved.</span>
</footer>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-51571233-1', 'auto');
  ga('send', 'pageview');
</script>


    </div>
  </body>
</html>